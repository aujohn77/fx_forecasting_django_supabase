{% extends "base.html" %}
{% block title %}Market {{ latest_date|date:"Y-m-d" }} USD Rates{% endblock %}

{% block content %}

<section class="card" style="margin-bottom:1rem;">
  <h2>USD Market Snapshot — {{ latest_date|date:"Y/m/d" }}</h2>
  <div class="table">
    <table>
      <thead>
        <tr>
            <th>Currency</th>
            <th>Rate</th>
            <th>Daily Δ%</th>
            <th>Weekly Δ%</th>
            <th>Monthly Δ%</th>
        </tr>
      </thead>

      <tbody>
        {% for row in table_rows %}
        <!-- NOTE: mk-row class + data-code for JS to target -->
        <tr class="mk-row" data-code="{{ row.code }}">
            <td>{{ row.label }}</td>
            <td>{{ row.rate|floatformat:4 }}</td>

            <td>
                {% if row.daily_change is not None %}
                {% if row.daily_change >= 0 %}
                    <span style="color:#4ade80;">
                    {{ row.daily_change|floatformat:2 }}%
                    </span>
                {% else %}
                    <span style="color:#f87171;">
                    {{ row.daily_change|floatformat:2 }}%
                    </span>
                {% endif %}
                {% else %}-{% endif %}
            </td>

            <td>
                {% if row.weekly_change is not None %}
                {% if row.weekly_change >= 0 %}
                    <span style="color:#4ade80;">
                    {{ row.weekly_change|floatformat:2 }}%
                    </span>
                {% else %}
                    <span style="color:#f87171;">
                    {{ row.weekly_change|floatformat:2 }}%
                    </span>
                {% endif %}
                {% else %}-{% endif %}
            </td>

            <td>
                {% if row.monthly_change is not None %}
                {% if row.monthly_change >= 0 %}
                    <span style="color:#4ade80;">
                    {{ row.monthly_change|floatformat:2 }}%
                    </span>
                {% else %}
                    <span style="color:#f87171;">
                    {{ row.monthly_change|floatformat:2 }}%
                    </span>
                {% endif %}
                {% else %}-{% endif %}
            </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
    <h2 style="margin:0;">
      5-Year Exchange Rate Trend —
      <span id="mk-currency-label"></span>
    </h2>
    <div style="display:flex;gap:.5rem;align-items:center;">
      <button id="mk-prev" type="button">◀</button>
      <button id="mk-next" type="button">▶</button>
    </div>
  </div>

  <div style="margin-top:1rem;">
    <canvas id="mk-chart" height="80"></canvas>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {

  const series = JSON.parse('{{ series_json|escapejs }}');
  const names  = JSON.parse('{{ currency_names_json|escapejs }}');
  const codes  = JSON.parse('{{ all_quotes_json|escapejs }}');

  const labelEl = document.getElementById('mk-currency-label');
  const ctx     = document.getElementById('mk-chart').getContext('2d');
  const prevBtn = document.getElementById('mk-prev');
  const nextBtn = document.getElementById('mk-next');
  const cardEl  = document.getElementById('mk-card');  // may be null; that's ok

  // all table rows we can highlight
  const rows = document.querySelectorAll('.mk-row');

  let idx = 0;
  let chart = null;
  let autoTimer = null;

  // --- Color palette: one color per currency -------------------
  const plotColors = {
    EUR: '#4ade80', // green
    GBP: '#60a5fa', // blue
    AUD: '#facc15', // yellow
    NZD: '#a78bfa', // purple
    JPY: '#fb7185', // pink/red
    CNY: '#34d399', // teal
    CHF: '#f87171', // soft red
    CAD: '#38bdf8', // cyan
    MXN: '#fbbf24', // amber
    INR: '#f472b6', // rose
    BRL: '#10b981', // emerald
    KRW: '#22d3ee'  // sky
  };

  function getColor(code) {
    return plotColors[code] || '#93c5fd'; // fallback blue
  }
  // --------------------------------------------------------------

  // highlight the matching table row
  function highlightRow(code) {
    rows.forEach(tr => {
      if (tr.dataset.code === code) {
        tr.classList.add('mk-row-active');
      } else {
        tr.classList.remove('mk-row-active');
      }
    });
  }

  function renderChart() {
    if (!codes.length) return;

    const code = codes[idx];
    const pts  = series[code] || [];
    const labels = pts.map(p => p.date);
    const data   = pts.map(p => p.rate);

    const name = names[code] ? `${code} (${names[code]})` : code;
    labelEl.textContent = name;

    // update table highlight
    highlightRow(code);

    const cfg = {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: name,
          data: data,
          borderWidth: 2,
          tension: 0.1,
          pointRadius: 0,
          borderColor: getColor(code),
          backgroundColor: 'transparent'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          x: {
            ticks: { maxTicksLimit: 8 },
            grid: { display: false }
          },
          y: {
            ticks: { maxTicksLimit: 6 },
            grid: { color: 'rgba(255,255,255,0.05)' }
          }
        }
      }
    };

    if (chart === null) {
      chart = new Chart(ctx, cfg);
    } else {
      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.data.datasets[0].label = name;
      chart.data.datasets[0].borderColor = getColor(code);
      chart.update();
    }
  }

  function goNext() {
    idx = (idx + 1) % codes.length;
    renderChart();
  }

  function goPrev() {
    idx = (idx - 1 + codes.length) % codes.length;
    renderChart();
  }

  function startAuto() {
    stopAuto();
    // change currency every 8 seconds (adjust if you want)
    autoTimer = setInterval(goNext, 8000);
  }

  function stopAuto() {
    if (autoTimer !== null) {
      clearInterval(autoTimer);
      autoTimer = null;
    }
  }

  prevBtn.addEventListener('click', () => {
    goPrev();
    startAuto();   // reset timer after manual click
  });

  nextBtn.addEventListener('click', () => {
    goNext();
    startAuto();
  });

  // Optional: pause auto-rotation while mouse is over the card
  if (cardEl) {
    cardEl.addEventListener('mouseenter', stopAuto);
    cardEl.addEventListener('mouseleave', startAuto);
  }

  renderChart();
  startAuto();   // start automatic carousel
});
</script>

{% endblock %}
