{% extends "base.html" %}
{% block title %}
  Forecasts{% if forecast_date %} {{ forecast_date|date:"Y-m-d" }} USD Rates{% else %} â€“ USD Rates{% endif %}
{% endblock %}

{% block nav_projects_active %}nav-link-active{% endblock %}

{% block nav_row2 %}
<nav class="subnav">
  <a href="{% url 'portfolio:project_model_deploy' %}" class="nav-link nav-link-active">
    FX Model Deployment Demo
  </a>
  <a href="{% url 'portfolio:project_amazon_recommender' %}" class="nav-link">
    Amazon-style Product Recommender
  </a>
  <a href="{% url 'portfolio:project_lead_conversion' %}" class="nav-link">
    Lead Conversion Prediction
  </a>
  <a href="{% url 'portfolio:project_customer_segmentation' %}" class="nav-link">
    Customer Segmentation
  </a>
</nav>
{% endblock %}

{% block nav_row3 %}
<nav class="subnav">
  <a href="{% url 'market' %}" class="nav-link">Market</a>
  <a href="{% url 'forecast' %}" class="nav-link nav-link-active">Forecasts</a>
</nav>
{% endblock %}

{% block content %}

<section class="card">

  <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;">
    <h2>
        USD Forecast Overview â€” {% if forecast_date %}{{ forecast_date|date:"Y/m/d" }}{% else %}N/A{% endif %}
    </h2>

    {% if model_codes %}
    <form method="get" id="model-form" style="display:flex;align-items:center;gap:.4rem;">
      <label for="model-select">Model:</label>
      <select id="model-select" name="model" onchange="this.form.submit()">
        {% for m in model_codes %}
          <option value="{{ m }}" {% if m == selected_model %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
      {% if chart_quote %}
        <input type="hidden" name="quote" value="{{ chart_quote }}">
      {% endif %}
    </form>
    {% endif %}
  </header>

  <div class="table">
    <table>
      <thead>
        <tr>
          <th>Currency</th>
          <th>Current</th>
          <th>Forecast</th>
          <th>Î”%</th>
        </tr>
      </thead>
      <tbody>
        {% for row in table_rows %}
        <!-- fc-row + data-code so JS can highlight like market page -->
        <tr class="fc-row" data-code="{{ row.code }}">
          <td>{{ row.label }}</td>
          <td>{{ row.current_rate|floatformat:4 }}</td>
          <td>
            {% if row.forecast_rate %}
              {{ row.forecast_rate|floatformat:4 }}
            {% else %}
              <span style="color:var(--muted)">n/a</span>
            {% endif %}
          </td>
          <td>
            {% if row.delta_pct is not None %}
              {% if row.delta_pct > 0 %}
                <span class="up">+{{ row.delta_pct|floatformat:2 }}%</span>
              {% elif row.delta_pct < 0 %}
                <span class="down">{{ row.delta_pct|floatformat:2 }}%</span>
              {% else %}
                <span>{{ row.delta_pct|floatformat:2 }}%</span>
              {% endif %}
            {% else %}
              <span style="color:var(--muted)">â€“</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" style="color:var(--muted)">No forecasts available.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;">
    <h2 style="margin:0;">
      60-Day Trend â€”
      <span id="fc-currency-label">{{ chart_quote }}</span>
      (Model: {{ selected_model }})
    </h2>
    <div style="display:flex;gap:.4rem;align-items:center;">
      <button id="fc-prev" type="button">â—€</button>
      <button id="fc-next" type="button">â–¶</button>
    </div>
  </header>

  <div class="chart-container">
    <canvas id="forecastChart"></canvas>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const seriesPayload = JSON.parse('{{ chart_series_json|escapejs }}');
  const codes = JSON.parse('{{ available_quotes_json|escapejs }}');
  const names = JSON.parse('{{ currency_names_json|escapejs }}');
  const initialCode = '{{ chart_quote }}';

  const labelEl = document.getElementById('fc-currency-label');
  const canvas = document.getElementById('forecastChart');
  const prevBtn = document.getElementById('fc-prev');
  const nextBtn = document.getElementById('fc-next');

  // Forecast table rows for highlight
  const fcRows = document.querySelectorAll('.fc-row');

  function highlightForecastRow(code) {
    fcRows.forEach(tr => {
      if (tr.dataset.code === code) {
        tr.classList.add('fc-row-active');
      } else {
        tr.classList.remove('fc-row-active');
      }
    });
  }

  // Same color palette as market page
  const plotColors = {
    EUR: '#4ade80', // green
    GBP: '#60a5fa', // blue
    AUD: '#facc15', // yellow
    NZD: '#a78bfa', // purple
    JPY: '#fb7185', // pink/red
    CNY: '#34d399', // teal
    CHF: '#f87171', // soft red
    CAD: '#38bdf8', // cyan
    MXN: '#fbbf24', // amber
    INR: '#f472b6', // rose
    BRL: '#10b981', // emerald
    KRW: '#22d3ee'  // sky
  };
  function getColor(code) {
    return plotColors[code] || '#93c5fd';
  }

  let idx = Math.max(0, codes.indexOf(initialCode));
  let chart = null;
  let autoTimer = null;

  function renderChart() {
    if (!canvas || !window.Chart || !codes.length) return;

    const code = codes[idx];
    const payload = seriesPayload[code] || { labels: [], actual: [], backtest: [] };
    const labels = payload.labels || [];
    const actual = payload.actual || [];
    const backtest = payload.backtest || [];

    const name = names[code] ? `${code} (${names[code]})` : code;
    labelEl.textContent = name;

    // ðŸ”¹ keep table highlight in sync with chart currency
    highlightForecastRow(code);

    const cfg = {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Actual',
            data: actual,
            borderWidth: 2,
            tension: 0.2,
            borderColor: getColor(code),
            backgroundColor: 'transparent',
            pointRadius: 0,
            pointHoverRadius: 3
          },
          {
            label: 'Backtest',
            data: backtest,
            borderWidth: 2,
            tension: 0.2,
            borderColor: '#ffffff',
            backgroundColor: 'transparent',
            borderDash: [6, 4],
            pointRadius: 0,
            pointHoverRadius: 3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            labels: { boxWidth: 12 }
          }
        },
        scales: {
          x: {
            ticks: { maxTicksLimit: 10 },
            grid: { display: false }
          },
          y: {
            grid: { color: 'rgba(255,255,255,0.05)' }
          }
        }
      }
    };

    if (chart === null) {
      chart = new Chart(canvas.getContext('2d'), cfg);
    } else {
      chart.data.labels = labels;
      chart.data.datasets[0].data = actual;
      chart.data.datasets[0].borderColor = getColor(code);
      chart.data.datasets[1].data = backtest;
      chart.update();
    }
  }

  function goNext() {
    if (!codes.length) return;
    idx = (idx + 1) % codes.length;
    renderChart();
  }

  function goPrev() {
    if (!codes.length) return;
    idx = (idx - 1 + codes.length) % codes.length;
    renderChart();
  }

  function startAuto() {
    if (autoTimer !== null) {
      clearInterval(autoTimer);
    }
    if (codes.length > 1) {
      autoTimer = setInterval(goNext, 8000); // rotate every 8s
    }
  }

  if (prevBtn) {
    prevBtn.addEventListener('click', () => {
      goPrev();
      startAuto();  // keep auto-rotation going
    });
  }
  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      goNext();
      startAuto();
    });
  }

  renderChart();
  startAuto();   // auto-rotate; we do NOT pause on hover
</script>

{% endblock %}
